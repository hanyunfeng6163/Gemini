(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-1825f3af"],{"0a49":function(t,e,r){var n=r("9b43"),o=r("626a"),a=r("4bf8"),i=r("9def"),s=r("cd1c");t.exports=function(t,e){var r=1==t,c=2==t,l=3==t,u=4==t,f=6==t,d=5==t||f,h=e||s;return function(e,s,m){for(var p,v,y=a(e),g=o(y),k=n(s,m,3),_=i(g.length),b=0,w=r?h(e,_):c?h(e,0):void 0;_>b;b++)if((d||b in g)&&(p=g[b],v=k(p,b,y),t))if(r)w[b]=v;else if(v)switch(t){case 3:return!0;case 5:return p;case 6:return b;case 2:w.push(p)}else if(u)return!1;return f?-1:l||u?u:w}}},"112c":function(t,e,r){"use strict";r("5fd2")},"5fd2":function(t,e,r){},7514:function(t,e,r){"use strict";var n=r("5ca1"),o=r("0a49")(5),a="find",i=!0;a in[]&&Array(1)[a]((function(){i=!1})),n(n.P+n.F*i,"Array",{find:function(t){return o(this,t,arguments.length>1?arguments[1]:void 0)}}),r("9c6c")(a)},"8ce9":function(t,e,r){"use strict";r.r(e);var n=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("div",[r("Row",[r("Card",[r("p",{attrs:{slot:"title"},slot:"title"},[r("Icon",{attrs:{type:"md-person"}}),t._v("\n        工单审核\n      ")],1),r("Row",[r("Col",{attrs:{span:"24"}},[r("Form",{attrs:{inline:""}},[r("FormItem",[r("Poptip",{attrs:{confirm:"",title:"您确认删除这些工单信息吗?"},on:{"on-ok":t.delrecordData}},[r("Button",{attrs:{type:"warning"}},[t._v("删除记录")])],1)],1),r("FormItem",[r("Poptip",{attrs:{trigger:"hover",title:"提示",content:"此开关用于打开实时表格数据更新功能"}},[r("i-switch",{attrs:{size:"large"},on:{"on-change":t.refreshForm},model:{value:t.valve,callback:function(e){t.valve=e},expression:"valve"}},[r("span",{attrs:{slot:"open"},slot:"open"},[t._v("打开")]),r("span",{attrs:{slot:"close"},slot:"close"},[t._v("关闭")])])],1)],1),r("FormItem",[r("Input",{attrs:{placeholder:"账号名"},on:{"on-keyup":function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.queryData(e)}},model:{value:t.find.user,callback:function(e){t.$set(t.find,"user",e)},expression:"find.user"}})],1),r("FormItem",[r("DatePicker",{staticStyle:{width:"250px"},attrs:{format:"yyyy-MM-dd HH:mm",type:"datetimerange",placeholder:"请选择查询的时间范围",editable:!1},on:{"on-change":function(e){t.find.picker=e}},model:{value:t.find.picker,callback:function(e){t.$set(t.find,"picker",e)},expression:"find.picker"}})],1),r("FormItem",[r("Button",{attrs:{type:"success"},on:{click:t.queryData}},[t._v("查询")]),r("Button",{staticClass:"margin-left-10",attrs:{type:"primary"},on:{click:t.queryCancel}},[t._v("重置")])],1)],1),r("Table",{ref:"selection",attrs:{border:"",columns:t.columns,data:t.tableData,stripe:""},on:{"on-selection-change":t.delrecordList},scopedSlots:t._u([{key:"action",fn:function(e){var n=e.row;return[5!==n.Status||"perform"===t.auth?r("div",[2===n.Status||"perform"===t.auth&&5===n.Status?r("Button",{attrs:{type:"primary",size:"small",ghost:""},on:{click:function(e){return t.openOrder(n)}}},[t._v("审批\n                ")]):t._e(),1===n.Status||4===n.Status?r("Button",{attrs:{type:"success",size:"small",ghost:""},on:{click:function(e){return t.orderDetail(n)}}},[t._v("\n                  执行结果\n                ")]):t._e(),r("Poptip",{attrs:{confirm:"",title:"确定要中止该工单吗？",transfer:""},on:{"on-ok":function(e){return t.delayKill(n)}}},[3===n.Status&&"none"!==n.Delay?r("Button",{attrs:{type:"error",size:"small",ghost:""}},[t._v("\n                    延时工单中止\n                  ")]):t._e()],1),3===n.Status&&0===n.Type?r("Button",{staticClass:"margin-left-10",attrs:{ghost:"",size:"small",type:"warning"},on:{click:function(e){return t.timerOsc(n)}}},[t._v("osc进度\n                ")]):t._e()],1):t._e()]}},{key:"delay",fn:function(e){var n=e.row;return["none"!==n.Delay?r("span",[t._v(t._s(n.Delay))]):r("span",[t._v("无")])]}}])}),r("br"),r("Page",{ref:"page",attrs:{total:t.pagenumber,"show-elevator":"","page-size":20},on:{"on-change":t.refreshData}})],1)],1)],1)],1),r("Modal",{attrs:{title:"OSC进度展示",closable:!1,"ok-text":"osc终止"},on:{"on-cancel":t.oscClose,"on-ok":t.oscKill},model:{value:t.osc.open,callback:function(e){t.$set(t.osc,"open",e)},expression:"osc.open"}},[r("Col",{attrs:{offset:"6"}},[r("i-circle",{attrs:{size:250,"trail-width":4,"stroke-width":5,percent:t.osc.percent,"stroke-linecap":"square","stroke-color":"#43a3fb"}},[r("div",{staticClass:"demo-Circle-custom"},[r("h1",[t._v(t._s(t.osc.percent)+"%")]),r("span",[t._v("\n              当前正在执行第\n              "),r("i",[t._v(t._s(t.osc.current))]),t._v("\n            条\n          ")])])])],1)],1),r("Modal",{attrs:{width:"1000"},model:{value:t.modal2,callback:function(e){t.modal2=e},expression:"modal2"}},[r("p",{staticStyle:{color:"#f60","font-size":"16px"},attrs:{slot:"header"},slot:"header"},[r("Icon",{attrs:{type:"information-circled"}}),r("span",[t._v("SQL工单详细信息")])],1),r("Form",{attrs:{"label-position":"right"}},[r("FormItem",{attrs:{label:"环境:"}},[r("span",[t._v(t._s(t.formitem.IDC))])]),r("FormItem",{attrs:{label:"连接名称:"}},[r("span",[t._v(t._s(t.formitem.Source))])]),r("FormItem",{attrs:{label:"数据库库名:"}},[r("span",[t._v(t._s(t.formitem.Base))])]),r("FormItem",{attrs:{label:"数据库表名:"}},[r("span",[t._v(t._s(t.formitem.Table))])]),r("FormItem",{attrs:{label:"定时执行:"}},[r("span",[t._v(t._s(t.formitem.Delay))])]),r("FormItem",{attrs:{label:"工单说明:"}},[r("span",[t._v(t._s(t.formitem.Text))])]),r("FormItem",[r("Table",{attrs:{columns:t.sql_columns,data:t.sql,"max-height":300}})],1),t.multi&&"admin"===t.auth?r("FormItem",{attrs:{label:"选择执行人:",required:""}},[r("Select",{staticStyle:{width:"20%"},model:{value:t.multi_name,callback:function(e){t.multi_name=e},expression:"multi_name"}},t._l(t.multi_list,(function(e){return r("Option",{key:e.Username,attrs:{value:e.Username}},[t._v(t._s(e.Username))])})),1)],1):t._e()],1),r("div",{attrs:{slot:"footer"},slot:"footer"},[r("Button",{on:{click:function(e){t.modal2=!1}}},[t._v("取消")]),r("Button",{attrs:{type:"warning",loading:t.loading},nativeOn:{click:function(e){return t.testTo()}}},[t.loading?r("span",[t._v("检测中")]):r("span",[t._v("检测sql")])]),t.multi?[r("Button",{attrs:{type:"error"},on:{click:function(e){return t.rejectTo()}}},[t._v("驳回")]),"admin"===t.auth?r("Button",{attrs:{type:"success",disabled:t.summit},on:{click:function(e){return t.agreedTo()}}},[t._v("同意")]):"perform"===t.auth?r("Button",{attrs:{type:"success"},on:{click:function(e){return t.performTo()}}},[t._v("执行")]):t._e()]:[r("Button",{attrs:{type:"error"},on:{click:function(e){return t.rejectTo()}}},[t._v("驳回")]),r("Button",{attrs:{type:"success",disabled:t.summit},on:{click:function(e){return t.performTo()}}},[t._v("执行")])]],2)],1),r("Modal",{on:{"on-ok":t.rejectText},model:{value:t.reject.reje,callback:function(e){t.$set(t.reject,"reje",e)},expression:"reject.reje"}},[r("p",{staticStyle:{color:"#f60","font-size":"16px"},attrs:{slot:"header"},slot:"header"},[r("Icon",{attrs:{type:"information-circled"}}),r("span",[t._v("SQL工单驳回理由说明")])],1),r("Input",{attrs:{type:"textarea",autosize:{minRows:15,maxRows:15},placeholder:"请填写驳回说明"},model:{value:t.reject.textarea,callback:function(e){t.$set(t.reject,"textarea",e)},expression:"reject.textarea"}})],1)],1)},o=[],a=(r("ac4d"),r("8a81"),r("5df3"),r("1c4c"),r("7f7f"),r("6b54"),r("7514"),r("ac6a"),r("bc3a")),i=r.n(a),s=r("c622");function c(t,e){var r;if("undefined"===typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(r=l(t))||e&&t&&"number"===typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){r=t[Symbol.iterator]()},n:function(){var t=r.next();return i=t.done,t},e:function(t){s=!0,a=t},f:function(){try{i||null==r.return||r.return()}finally{if(s)throw a}}}}function l(t,e){if(t){if("string"===typeof t)return u(t,e);var r=Object.prototype.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?u(t,e):void 0}}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}var f={name:"Sqltable",data:function(){return{osc:{percent:0,open:!1,current:1},loading:!1,sql_columns:[{type:"expand",width:50,render:function(t,e){return t(s["a"],{props:{row:e.row}})}},{title:"当前检查的sql",key:"SQL",render:function(t,e){var r=e.row.SQL.substring(0,40)+"...";return t("span",r)}},{title:"阶段",key:"Status",width:"150"},{title:"错误等级",key:"Level",width:"100"},{title:"错误信息",key:"Error",tooltip:!0},{title:"影响行数",key:"AffectRows",width:"120"}],columns:[{type:"selection",width:60,align:"center",fixed:"left"},{title:"工单编号:",key:"WorkId",sortable:!0,sortType:"desc",width:155},{title:"工单说明:",key:"Text",tooltip:!0},{title:"是否备份",key:"Backup",width:100},{title:"提交时间:",key:"Date",sortable:!0},{title:"提交账号",key:"Username",sortable:!0},{title:"真实姓名",key:"RealName",sortable:!0},{title:"定时执行",key:"Delay",slot:"delay"},{title:"执行人",key:"Executor",sortable:!0},{title:"状态",key:"Status",width:150,render:function(t,e){var r=e.row,n="",o="";return 2===r.Status?(n="primary",o="待审核"):0===r.Status?(n="error",o="驳回"):1===r.Status?(n="success",o="执行成功"):4===r.Status?(n="error",o="执行失败"):5===r.Status?(n="default",o="待执行"):(n="warning",o="执行中"),t("Tag",{props:{type:"dot",color:n}},o)},sortable:!0},{title:"操作",key:"action",width:200,align:"center",slot:"action"}],modal2:!1,sql:[],formitem:{},summit:!0,reject:{reje:!1,textarea:""},tableData:[],pagenumber:1,delrecord:[],callback_time:null,switch_show:!0,multi:Boolean,auth:sessionStorage.getItem("auth"),multi_list:{},multi_name:"",reboot:null,valve:!0,find:{picker:[],user:"",valve:!1},ws:null,fk:""}},methods:{delayKill:function(t){var e=this;i.a.get("".concat(this.$config.url,"/audit/kill/").concat(t.WorkId)).then((function(t){e.$config.notice(t.data),e.refreshData()})).catch((function(t){return e.$config.err_notice(e,t)}))},timerOsc:function(t){this.osc.open=!0,this.osc.current=0,this.osc.percent=0,this.fk=t.WorkId;var e=this;this.ws=setInterval((function(){e.openOSC(t)}),3e3)},openOSC:function(){var t=this;i.a.get("".concat(this.$config.url,"/audit/fetch_osc/").concat(this.fk)).then((function(e){t.osc.percent=e.data.p,t.osc.current=e.data.s})).catch((function(e){return t.$config.err_notice(t,e)}))},oscKill:function(){var t=this;i.a.delete("".concat(this.$config.url,"/audit/fetch_osc/").concat(this.fk)).then((function(e){t.$config.notice(e.data),t.oscClose()})).catch((function(e){t.$config.err_notice(t,e),t.oscClose()}))},oscClose:function(){clearInterval(this.ws)},openOrder:function(t){var e=this;this.summit=!0,this.sql=[],this.modal2=!0,2===t.Status?this.switch_show=!0:this.switch_show=!1,i.a.get("".concat(this.$config.url,"/audit/sql?k=").concat(t.WorkId)).then((function(r){e.sql=r.data.sql,e.formitem.IDC=r.data.idc,e.formitem={WorkId:t.WorkId,IDC:r.data.idc,Source:r.data.source,Delay:r.data.delay,Base:r.data.base,Text:r.data.text,Table:r.data.table,Type:r.data.type}})).catch((function(t){e.$config.err_notice(e,t)}))},agreedTo:function(){var t=this;""===this.multi_name?this.$Message.error("请选择执行人!"):i.a.post("".concat(this.$config.url,"/audit/refer/perform"),{perform:this.multi_name,WorkId:this.formitem.WorkId}).then((function(e){t.$config.notice(e.data),t.modal2=!1,t.refreshData(t.$refs.page.currentPage)})).catch((function(e){t.$config.err_notice(t,e)}))},performTo:function(){var t=this;this.modal2=!1,i.a.post("".concat(this.$config.url,"/audit/execute"),{workid:this.formitem.WorkId}).then((function(e){t.$config.notice(e.data),t.refreshData(t.$refs.page.currentPage)})).catch((function(e){t.$config.err_notice(t,e)}))},rejectTo:function(){this.modal2=!1,this.reject.reje=!0},testTo:function(){var t=this;this.loading=!0;var e,r="",n=c(this.sql);try{for(n.s();!(e=n.n()).done;){var o=e.value;r+=o.SQL}}catch(s){n.e(s)}finally{n.f()}var a=!1;1===this.formitem.Type&&(a=!0),i.a.put("".concat(this.$config.url,"/fetch/test"),{source:this.formitem.Source,database:this.formitem.Base,table:this.formitem.table,sql:r,isDMl:a}).then((function(e){t.sql=e.data;var r=0;t.sql.forEach((function(t){0!==t.Level&&(r+=1)})),t.summit=0!==r,t.loading=!1})).catch((function(e){t.$config.err_notice(t,e)}))},rejectText:function(){var t=this;i.a.post("".concat(this.$config.url,"/audit/reject"),{text:this.reject.textarea,work:this.formitem.WorkId}).then((function(e){t.$config.notice(e.data),t.refreshData(t.$refs.page.currentPage)})).catch((function(e){t.$config.err_notice(t,e)}))},orderDetail:function(t){this.$router.push({name:"orderlist",query:{workid:t.WorkId,status:t.Status}})},refreshData:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;i.a.put("".concat(this.$config.url,"/audit"),{page:e,find:this.find}).then((function(e){if(t.multi=e.data.multi,!t.multi)for(var r=0;r<t.columns.length;r++)"Executor"===t.columns[r].key&&t.columns.splice(r,1);t.tableData=e.data.data,t.tableData.forEach((function(t){1===t.Backup?t.Backup="是":t.Backup="否"})),t.pagenumber=e.data.page,t.multi_list=e.data.multi_list})).catch((function(e){t.$config.err_notice(t,e)}))},delrecordList:function(t){this.delrecord=t},delrecordData:function(){var t=this,e=this.$refs.page.currentPage;this.tableData.length===this.delrecord.length&&1!==e&&(e-=1),i.a.post("".concat(this.$config.url,"/audit/undo"),{u:this.delrecord=this.delrecord.map((function(t){return t.WorkId}))}).then((function(r){t.$config.notice(r.data),t.refreshData(e)})).catch((function(e){t.$config.err_notice(t,e)}))},refreshForm:function(t){if(t){var e=this;this.reboot=setInterval((function(){e.refreshData(e.$refs.page.currentPage)}),5e3)}else clearInterval(this.reboot)},queryData:function(){this.find.valve=!0,this.refreshData()},queryCancel:function(){this.find=this.$config.clearPicker(this.find),this.$refs.page.currentPage=1,this.refreshData()}},mounted:function(){this.refreshData(),this.refreshForm(this.valve)},destroyed:function(){clearInterval(this.ws),clearInterval(this.reboot)}},d=f,h=(r("112c"),r("2877")),m=Object(h["a"])(d,n,o,!1,null,"4c532fa3",null);e["default"]=m.exports},c622:function(t,e,r){"use strict";var n=function(){var t=this,e=t.$createElement,r=t._self._c||e;return r("Row",[r("Col",[r("code",[t._v(t._s(t.row.SQL))])])],1)},o=[],a={name:"expandTable",props:{row:Object}},i=a,s=r("2877"),c=Object(s["a"])(i,n,o,!1,null,"564f6147",null);e["a"]=c.exports},cd1c:function(t,e,r){var n=r("e853");t.exports=function(t,e){return new(n(t))(e)}},e853:function(t,e,r){var n=r("d3f4"),o=r("1169"),a=r("2b4c")("species");t.exports=function(t){var e;return o(t)&&(e=t.constructor,"function"!=typeof e||e!==Array&&!o(e.prototype)||(e=void 0),n(e)&&(e=e[a],null===e&&(e=void 0))),void 0===e?Array:e}}}]);
//# sourceMappingURL=chunk-1825f3af.e5374511.js.map